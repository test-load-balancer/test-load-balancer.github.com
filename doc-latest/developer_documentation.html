---
layout: default
title: Developing TLB
keywords: tlb, test-load-balancer, how to use, usage examples, snippets, tlb examples
description: Information about Test Load Balancer to developers to help contribute
---
{% include doc_menu %}
<h3>Enhancing and Contributing to TLB</h3>
<div class="scope section">
  TLB is written ground up with the intention of making it as customizable as possible. That means you can add new algorithms, add support to new frameworks etc with relatively less work. The idea is TLB takes care of all the boring plumbing/TLB specific work and lets the end users to write only what matters to them.
  <p class="clob_end" />
  To understand how TLB works, please refer to the {% include concepts_link %}. We strongly recommend you go through the whole page so that you get a good understanding of TLB's internals if you intend to customize it.
  <p class="clob_end" />
  You can also look at the current algorithm we are working on. You can find it under "set-part" in the <a href="/projects.html">Projects</a> listing. That page also lists all the TLB projects. If any of them interest you, you can choose to give us patch hungry developers some tasty bug fixes or features :)
</div>
<hr/>
<h3>Adding new Splitters and Orderers</h3>
<div class="scope section">
  Given that most of the algorithm enhancements are for splitting and reordering, the following sections talks about how to do it.
  <p class="clob_end" />
  <h4>Splitter</h4>
  You can either extend the <code>tlb.splitter.JobFamilyAwareSplitter</code> or <code>tlb.splitter.TestSplitter</code> class and implement the <code>filterSuites</code> method using whatever algorithm you want to use. Then, you just need to either use the <code>TLB_SPLITTER</code> to be this, if you want to just use your algorithm, or add it to the chain of splitters in the <code>TLB_PREFERRED_SPLITTERS</code>. That way you can also leverage the built in algorithms. Do check out the {% include config_link %} to double check how to configure the splitter that you just wrote.
  <p class="clob_end" />
  <strong>NOTE:</strong> Remember that splitters needs to guarentee the contract of mutual exclusion and collective exhaustion. 
  <p class="clob_end" />
  <h4>Orderer</h4>
  You can extend the <code>tlb.orderer.TestOrderer</code> class and override the compare method. This is what is used for sorting the test suites. You can then add this to the <code>TLB_ORDERER</code> to get ordering the way you want it. 
  <p class="clob_end" />
  <strong>NOTE:</strong> Remember, the contract of the orderer is that you would just reorder and not change the size of the list passed to you. If you do, then the mutual exclusion and collective exhaustion rule is broken. 
  <p class="clob_end" />
  Any algorithm class that you write just needs to be in the classpath of TLB java runtime and TLB takes care of loading the class. 
</div>
<hr/>
<h3>Adding support for new frameworks</h3>
<div class="scope section">
  <p class="clob_end" /> 
  To load-balance tests, TLB needs to hook up with 2 kinds of frameworks.
  <p class="clob_end" />
  <ul>
    <li>Testing framework: This is the framework that actually runs the tests (for instance junit or rspec etc)</li>
    <li>Build framework: This is the framework that calls out to the tests (command line invocation, Ant, Rake etc)</li>
  </ul>
  <p class="clob_end" />
  <h4>Supporting a new Testing framework</h4>
  <ol>
    <li>TLB assumes that a test framework provides an option to specify a list of test resources (for example: files, test case name, DLLs etc) that get executed. The list is passed (Refer to the next section on how to do this) to the Splitter criteria chain and criteria prunes the file resource list. After pruning, the list of the file resources is passed through the orderer, where it gets re-ordered. The contract is that the orderer does not change the number of file resources.
      <p class="clob_end" />
      The final list of test resources is what is fed into the test framework for execution.
    </li>
    <li>
      Once the tests are executed, TLB needs a way to capture the test result and the time each test took to execute in order to report back to the TLB Server. This is the feedback that is used for partitioning tests in future. This feedback is what allows TLB to partion and order tests accurately and sensibly. Refer to the next section on how to do this.
    </li>
  </ol>
  <h4>Supporting a new Build tool</h4>
  Supporting build tools is a matter of implementing the end user interface which delegate to the Splitter and Orderer. Build tool integration goes a little further and does the plumbing work of attaching listeners to the test running framework so the feedback can be posted. 
  <p class="clob_end" />
  For instance, Ant support hooks up at the fileset-filter level for partitioning and re-ordering and attaches a JUnitResultFormatter with the test task, so the feedback gets posted. 
</div>
<hr />
<h3>Interacting with TLB in an alien environment</h3>
<div class="scope section">
  TLB is developed in Java. Hence Java is considered to be TLB's native environment. However, it can be used on any platform and using any language. We call a non-Java environment "Alien Environment".
  <p class="clob_end"/>
  Interacting with TLB basically involves using the balancing and reordering algorithms and posting test data to the TLB server. Since this is something that is common and every platform/language need not reinvent, we provide a simple way of reusing what we have implemented in Java.
  <p class="clob_end" />
  TLB has a concept called the <strong>Balancing Server</strong>. This is basically a really light weight RESTlet server that knows how to:
  <ul>
    <li>Prune a list of tests (Splitting) </li>
    <li>Reorder the pruned list of tests (Ordering) </li>
    <li>Send test information to the TLB server</li>
    <li>Fetch test information from the TLB server for splitting and ordering</li>
  </ul>
  <p class="clob_end" />
  Given that all these are taken care of, a developer who wants to implement Test Load Balancing for a given platform or language, just needs to hookup with the test frameworks and the build frameworks as mentioned in the previous section and then use the Balancing server to do the load balancing.
</div>
<hr/>
<h3>Using the Balancing Server</h3>
<div class="section scope">
  The life cycle of how TLB balancer would be used to get support in the environment you are implementing for is as follows:
  <ol>
    <li>Start the balancing server. This is done using:
      <div class="code">
	<code>java -jar tlb-alien.jar</code>
      </div>
      You need to set a few environment variables which you can get from {% include config_link  %}. Please refer to the <i>"Balancer against TLB Server"</i> column to get the list of the variables that need to be set.
    </li>
    <li>Obtain the list of tests that need to be run from the test framework</li>
    <li>Pass this list along to the Balancing server. This can be done by doing a HTTP POST to the URL: <strong>http://localhost:${TLB_BALANCER_PORT}/balance</strong>
      <p class="clob_end" />
      The post body should be in the format:
      <p class="clob_end" />
      com/foo/project/test_file1<strong>\n</strong>com/bar/project/test_file2<strong>\n</strong>...com/bar/project/test_filex
      <p class="clob_end" />
      i.e. the body should have the name of the test resource (the format of the names is not important. It can be anything.) and each resource name is separated using "\n". Note that this needs to be "\n" irrespective of what platform you are on.
    </li>
    <li>The response body from the HTTP POST request gives you the pruned list of tests in the same format.</li>
    <li>After these tests are run, you need to pass along the test run time to the balancing server. You can do this by doing a HTTP POST to the URL: <strong>http://localhost:${TLB_BALANCER_PORT}/suite_time</strong>
      <p class="clob_end" />
      The post body should be in the format:
      <p class="clob_end" />
      com/foo/project/test_file1<strong>:</strong>123<strong>\n</strong>com/bar/project/test_file2<strong>:</strong>20<strong>\n</strong>...com/bar/project/test_filex<strong>:</strong>344
      <p class="clob_end" />
      i.e. the body should have the name of the test resource and its time (a valid integer) separated by a colon (":") and each entry separated by a "\n". The name should be tphe same as the one you send across for pruning and you report the result for.
    </li>
    <li>The results of the test too need to be posted if reorder functionality is to be supported. This can be done by doing a HTTP POST to the URL: <strong>http://localhost:${TLB_BALANCER_PORT}/suite_result</strong>
      <p class="clob_end" />
      The post body should be in the format:
      <p class="clob_end" />
      com/foo/project/test_file1<strong>:</strong>false<strong>\n</strong>com/bar/project/test_file2<strong>:</strong>false<strong>\n</strong>...com/bar/project/test_filex<strong>:</strong>true
      <p class="clob_end" />
      i.e. the body should have the name of the test resource and the result of the test separated by a colon (":") and each entry separated by a "\n". The value of the result can be either "false" or "true".
    </li>
    <li>Once all the tests are executed, shut down the balancing server. This can be done by going a HTTP GET to the URL: <strong>http://localhost:${TLB_BALANCER_PORT}/control/suicide</strong>
      <p class="clob_end" />
      Doing so will end the Balancing server process gracefully.
  </ol>
  <p class="clob_end" />
  As one can see, the balancing server can be used on any platform and any language as you can talk over HTTP to get the splitting and reordering done. This is the exactly how the {% include tlb_rb_link %} - the ruby support is implemented. {% include tlb_dot_net_link %}, which is being currently developed also used the same idea.
</div>
